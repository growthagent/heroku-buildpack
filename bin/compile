#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -eo pipefail

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BP_DIR=$(cd "$(dirname "${0:-}")"; cd ..; pwd)

indent() {
  sed -u 's/^/       /'
}

ASDF_DIR="$BUILD_DIR/.asdf/"
ASDF_CACHE="$CACHE_DIR/asdf/"
ASDF_VERSION=${ASDF_VERSION:-'0.7.8'}
if [ -f "$BUILD_DIR/.tool-versions" ]; then
  ASDF_VERSION="$(awk -F ' ' '{ if (match($1, "asdf")) {print $2} }' $BUILD_DIR/.tool-versions)"
fi
ASDF_COMPLELTION=". ${ASDF_DIR}/completions/asdf.bash"

mkdir -p "$ASDF_DIR"

# Copying from cache
if [ -d "$ASDF_CACHE" ]; then
  echo "-----> Copying asdf cache"
  cp -r "$ASDF_CACHE" "$ASDF_DIR"
  if [ -f "$ASDF_DIR/asdf.sh" ]; then
    . "$ASDF_DIR/asdf.sh"
  fi
else
  mkdir -p "$ASDF_CACHE"
fi

if ! [ -x "$(command -v asdf)" ]; then
  echo "-----> Installing asdf v${ASDF_VERSION}"
  git clone --quiet --depth=1 https://github.com/asdf-vm/asdf.git "$ASDF_DIR" --branch "v${ASDF_VERSION}" | indent
  . "$ASDF_DIR/asdf.sh"
elif [ "$(git symbolic-ref --short HEAD)" != "v${ASDF_VERSION}" ] ; then
  echo "-----> Switching to asdf v${ASDF_VERSION}"
  cd "$ASDF_DIR"
  git checkout "v${ASDF_VERSION}" | indent
  cd "$BUILD_DIR"
else
  echo "-----> Using asdf v${ASDF_VERSION}"
fi

if ! asdf plugin list | grep "purescript-zephyr"; then
  echo "-----> Adding asdf plugin purescript-zephyr"
  asdf plugin add purescript-zephyr https://github.com/instateam/asdf-purescript-zephyr.git | indent
else
  echo "-----> Updating asdf plugin purescript-zephyr"
  asdf plugin update purescript-zephyr | indent
fi

echo "-----> Packages asdf"
ls . | indent
ls $BUILD_DIR | indent
ls $CACHE_DIR | indent

echo "-----> Packages asdf plugins"
cat .tool-versions | indent

echo "-----> Install asdf plugins"
asdf install | indent

# Copying to cache
cp -r "$ASDF_DIR" "$ASDF_CACHE"

echo "-----> Creating asdf .profile.d script"
mkdir -p $BUILD_DIR/.profile.d/
cat << EOF > "$BUILD_DIR/.profile.d/asdf.sh"
# asdf will set \$PATH variables
. ${ASDF_DIR}/asdf.sh
export PATH=$PATH
# bash completions for debugging
. ${ASDF_DIR}/completions/asdf.bash
EOF

echo "-----> Creating asdf export script"
cat << EOF > $BP_DIR/export
#export PATH="${ASDF_DIR}/bin:${ASDF_DIR}/shims:\$PATH"
. ${ASDF_DIR}/asdf.sh
export PATH=$PATH
EOF

exit 0
