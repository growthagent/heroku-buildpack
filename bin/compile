#!/usr/bin/env bash

indent() {
  sed -u 's/^/       /'
}

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}

ASDF_DIR="$BUILD_DIR/.asdf/"
ASDF_VERSION=${ASDF_VERSION:-'0.7.8'}
ASDF_COMPLELTION=". ${ASDF_DIR}/completions/asdf.bash"

echo "$ASDF_DIR"
mkdir -p "$ASDF_DIR"
cd "$ASDF_DIR"
if ! [ -x "$(command -v asdf)" ]; then
  echo "-----> Installing asdf v${asdf_version}"
  git clone --depth=1 https://github.com/asdf-vm/asdf.git "$ASDF_DIR" --branch "v${ASDF_VERSION}" | indent
  . "$ASDF_DIR/asdf.sh"
  echo "Testing setup in $ASDF_DIR"
  ls $ASDF_DIR
  if ! [ -x "$(command -v asdf)" ]; then
    echo "Building asdf failed" | indent
    exit 1
  fi
elif [ "$(git symbolic-ref --short HEAD)" != "v${ASDF_VERSION}" ] ; then
  echo "-----> Switching to asdf v${ASDF_VERSION}"
  git checkout "v${ASDF_VERSION}" | indent
else
  echo "-----> Using asdf v${ASDF_VERSION}"
fi
cd "$BUILD_DIR"

if [ -f "$HOME/.bashrc" && -z $(grep "$asdf_completion" "$HOME/.bashrc")  ]; then
  echo "$ASDF_COMPLELTION" >> "$HOME/.bashrc"
else
  echo "$ASDF_COMPLELTION" > "$HOME/.bashrc"
fi

if ! asdf plugin-list | grep purescript-zephyr; then
  echo "-----> Adding asdf plugin purescript-zephyr"
  asdf plugin add purescript-zephyr https://github.com/instateam/asdf-purescript-zephyr.git | indent
else
  echo "-----> Updating asdf plugin purescript-zephyr"
  asdf plugin update purescript-zephyr | indent
fi

# TODO: remove
echo "plugins" | indent
ls $HOME/.asdf/plugins
echo "shim" | indent
ls $HOME/.asdf/shim

asdf install | indent

echo "-----> Creating asdf .profile.d script"
mkdir -p $BUILD_DIR/.profile.d/
tee "$BUILD_DIR/.profile.d/asdf.sh" <<EOF
echo "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
echo "sourcing asdf"
# asdf will set \$PATH variables
. ${ASDF_DIR}/asdf.sh
asdf install
EOF
echo "Created with:" | indent
cat "$BUILD_DIR/.profile.d/asdf.sh" | indent

exit 0
